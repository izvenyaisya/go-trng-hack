# rng-chaos — Документация

Проект `rng-chaos` — небольшой однопакетный Go-бинарник, реализующий детерминированный трёхуровневый поток генерации случайных данных (TRNG) с возможностями репродуцируемости, смешивания энтропии от разных источников и «отбеливания» выходных данных.

Файлы и структура
- `main.go` — точка входа, HTTP-сервер, маршруты и загрузка/сохранение состояния.
- `entropy.go` — источники энтропии и логика их объединения. Поддерживаемые режимы: `os`, `jitter`, `http`, `mix`, `repro`.
- `trng.go` / `drbg.go` — детерминированный генератор на базе HMAC-DRBG; обёртки для инициализации из seed/транзакции.
- `types.go` — основные структуры данных JSON (например, `SimulationData`, `GenerateParams`, `Transaction`, `GenerationProvenance`).
- `blockchain.go` / `store.json` — хранение транзакций в памяти и сохранение состояния на диск (в `store.json`).
- `stats.go`, `motion.go`, `render.go` — вспомогательные модули для статистики, визуализации/рендеринга и симуляций.
- `internal/nist` — интеграция с тестами NIST (платформо-зависимая часть).
- `tools/` — набор утилит для воспроизведения и отладки:
  - `run_generate.go` — пример запроса `/generate` и последующего извлечения статистики.
  - `run_generate_info.go` — пример получения `PerHTTPSeeds` для воспроизводимости.

Короткое описание архитектуры
- Поток: Источник энтропии -> Симуляция -> HMAC-DRBG (TRNG) -> Отбеливание (whitening) -> Транзакция и хранение.
- Детерминированность важна: режим `repro` и параметр `seed64` позволяют воссоздать конкретный прогон.
- Пер-HTTP seeds: при использовании HTTP-энтропии отдельные ответы приводят к детерминированным под-сидерам, которые сохраняются в транзакции для воспроизводимости.

Сборка и запуск

Требования
- Go 1.22 (указано в `go.mod`).

Сборка (в корне репозитория):

```powershell
gofmt -w .
go build
```

Запуск сервера:

```powershell
go run .
```

По умолчанию сервер слушает на `:4040` (см. `main.go`).

HTTP API

- `GET`/`POST /generate` — основной endpoint. Параметры (через query или JSON):
  - `entropy` — режим энтропии: `os`, `jitter`, `http`, `mix`, `repro`.
  - `seed64` — (при `repro`) числовой seed для точного воспроизведения.
  - `whiten` — режим отбеливания: `off`, `hmac`, `aes` (рекомендуется `aes`).
  Возвращает идентификатор транзакции и метаданные генерации.

- `GET /tx/{id}/info` — информация о транзакции, включает `PerHTTPSeeds` для воспроизводимости.
- `GET /tx/{id}/trng?n=<N>&format=hex` — читать N байт из TRNG, формат hex/bytes.
- `GET /tx/{id}/stats` — статистика/результаты симуляции для данной транзакции.

Режимы энтропии и воспроизводимость
- `os` — использует системный источник (не воспроизводимо).
- `jitter` — измерение задержек/джиттера как источник энтропии.
- `http` — делает запросы к внешним URL и детерминирует ответы в под-сиды.
- `mix` — смешение нескольких источников.
- `repro` — воспроизводимый режим: поведение является детерминированным при задании `seed64`.

Советы по воспроизводимости
- Используйте `repro` и указывайте `seed64` в запросе к `/generate`.
- Сохраните/проверьте `PerHTTPSeeds` из `/tx/{id}/info` — их можно использовать для точного воссоздания HTTP-энтропии позже.

Whitening (отбеливание)
- На этапе генерации можно применить схему отбеливания выходных байт (`hmac`, `aes`) или оставить без отбеливания (`off`).
- README рекомендация: `whiten=aes` даёт лучшие статистические свойства по умолчанию.

Хранение
- Все транзакции хранятся в памяти и сериализуются в файл `store.json` при остановке/сохранении. Это позволяет восстанавливать историю и обеспечивать репродукцию.

Инструменты разработчика
- `tools/run_generate.go` — быстрый сценарий, который вызывает `/generate` и затем `/tx/{id}/stats`.
- `tools/run_generate_info.go` — получает `PerHTTPSeeds` для созданной транзакции; полезно для тестов воспроизводимости.

Разработка и тесты
- Для отладки рекомендуется использовать режим `repro` и фиксированные `seed64`.
- При изменении алгоритмов TRNG/whitening — добавляйте детерминированные тесты (в `tools/` или отдельные unit-тесты) и валидируйте результаты через повторные прогоны с сохранёнными `PerHTTPSeeds`.

Файлы, которые стоит просмотреть первым
- `main.go` — маршруты, загрузка сохранения, настройки сервера.
- `entropy.go` — логика источников энтропии и `deriveSeed`/`rawFromHTTP`.
- `trng.go` и `drbg.go` — инициализация HMAC-DRBG и правила комбинирования seed'ов.

Лицензия и вклад
- Этот проект — учебный/исследовательский. Проверьте корневой каталог на наличие файла `LICENSE` перед публичным распространением.

Контакты и дальнейшие шаги
- Если нужно, могу:
  - Добавить пример `curl`/PowerShell запросов с типичными опциями.
  - Написать unit-тесты для проверки воспроизводимости и основных эндпоинтов.
  - Добавить примеры использования `tools/run_generate.go` и инструкции для `tools/`.

Краткое итоговое резюме
- `rng-chaos` — простой, детерминированный TRNG-сервер с упором на репродуцируемость и гибкие источники энтропии. Используйте `repro` + `seed64` для точных воспроизведений и `whiten=aes` для лучших выходных свойств.
